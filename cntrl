#!/bin/bash
# CNTRL ROOT LAUNCHER
# Usage: ./cntrl

echo "=================================="
echo "   INITIALIZING CNTRL OS v2.0   "
echo "=================================="

# Navigate to Core
cd _cntrl

# Ensure dependencies are installed
if [ ! -d "node_modules" ]; then
    echo ">> Installing dependencies..."
    npm install
    echo ">> Building system..."
    npm run build
fi

# Process Flags
HEADLESS=false
for arg in "$@"; do
    if [ "$arg" == "--headless" ]; then
        HEADLESS=true
    fi
done

# Ensure build exists
if [ ! -d "dist" ]; then
     echo ">> Building system..."
     npm run build
fi

# Start Server in background (silent)
echo ">> Starting Cortex..."
# Use PORT from .env if it exists, otherwise 3001
export PORT=${PORT:-3001}
npm start > logs/server.log 2>&1 &
SERVER_PID=$!

# Wait for server to likely be ready
echo ">> Waiting for port $PORT..."
while ! nc -z localhost $PORT; do   
  sleep 0.5
done

if [ "$HEADLESS" = true ]; then
    echo ">> Running in HEADLESS mode. API is at http://localhost:$PORT"
    echo ">> Press Ctrl+C to shutdown."
    wait $SERVER_PID
else
    # Launch CLI (Interactive TUI)
    echo ">> Launching Interface..."
    trap "kill $SERVER_PID" EXIT

    # npm run cli runs 'node dist/cli/index.js'
    npm run cli
fi
